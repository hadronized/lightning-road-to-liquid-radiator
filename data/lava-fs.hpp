#ifndef __LAVA_FS_HPP
#define __LAVA_FS_HPP

char const *SHD_LAVA_FS =
"#version 330 core\n"
"#define RAY_STEP 0.1\n"
"out vec4 frag;"
"uniform float time;"
"uniform vec4 res;"
"const float PI=3.14159265359;"
"const float PI2=2.*PI;"
"const float PI_2=PI/2.;"
"const float fovy=PI_2;"
"const float zfar=300.;"
"vec2 get_uv(){"
  "vec2 uv=2.*gl_FragCoord.xy*res.zw-1.;"
  "uv.y*=res.y*res.z;"
  "return uv;"
"}"
"float plasma(vec2 uv){"
  "return "
      "sin(uv.x*8.+time)*sin(uv.y*8.)"
     "+sin(length(vec2(cos(uv.x),sin(uv.y)))*24.+time)"
     "+sin(uv.y*12.);"
"}"
"float sweep(float d,float dl,float t){"
  "float a=80.*(mod(max(-1.,time-dl),6.82));"
  "float r=abs(d-a);"
  "return max(t-r,0.);"
"}"
"float intersect_terrain(vec3 cam,vec3 ray){"
  "vec3 p;"
  "float znear=cam.y/dot(ray,vec3(0.,-1.,0.));"
  "for (float s=znear,d=1.;s<=zfar;s+=(RAY_STEP*d)){"
    "p=cam+ray*s;"
    "if(p.y<=(plasma(p.xz/20.)-3.+sweep(s,72.0071,6.))){"
      "return s;"
    "}"
    "d=0.5*sqrt(s);" /* increase the factor makes the lava faster */
  "}"
  "return 0.;"
"}"
"void main(){"
  "vec2 uv=get_uv();"
  "float sinstart=time-54.0;"
  "vec3 ray=normalize(vec3(uv.x,uv.y-max(0.,0.5*pow(sin((sinstart)*0.1),2)),-1./tan(fovy/2.)));"
  "vec3 cam=vec3(sinstart*5.,4.-sin(time/2.)*4.,-sinstart*5.+max(0.,time-109.7)*60.);"
  "float terrain=intersect_terrain(cam,ray);"
  "vec3 lpos=vec3(0.,8.,0.);"
  "if(terrain!=0.){"
    "vec3 hit=cam+ray*terrain;"
    "float sweepDist=terrain;"
    "float pl=hit.y+3.;"
    "float atten=1.-terrain/zfar;"
    "frag=vec4(1.-pl/3.,0.5-pl,pl*-0.85,1.)*atten;"
    "frag+=vec4(0.,0.,2.5,1.)*("
        "sweep(sweepDist,68.6,2.)"
       "+sweep(sweepDist,69.0,2)"
       "+sweep(sweepDist,69.22,2.)"
       "+sweep(sweepDist,69.0583,2.)"
       "+sweep(sweepDist,69.6683,2.)"
       "+sweep(sweepDist,69.9373,1.)"
       "+sweep(sweepDist,70.0864,2.)"
       "+sweep(sweepDist,70.9557,1.)"
       "+sweep(sweepDist,71.2659,1.)"
       "+sweep(sweepDist,71.4982,1.)"
       "+sweep(sweepDist,72.0071,2.)"
      ")*pow(atten,2);"
  "}else{"
    "frag=vec4(0.);"
  "}"
"}";

#endif /* guard */

